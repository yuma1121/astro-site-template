---
import { site } from '../config/site';

export interface Props {
  title: string;
  description: string;
  ogImage?: string;
  canonicalUrl?: string;
  pubDate?: Date;
  updatedDate?: Date;
  isArticle?: boolean;
  breadcrumbs?: { name: string; url: string }[];
  noindex?: boolean;
  additionalJsonLd?: Record<string, any>[];
}

const {
  title,
  description,
  ogImage = site.defaultOgImage,
  canonicalUrl,
  pubDate,
  updatedDate,
  isArticle = false,
  breadcrumbs,
  noindex = false,
  additionalJsonLd = [],
} = Astro.props;

const siteName = site.name;
const fullTitle = title === siteName ? title : `${title} | ${siteName}`;
const resolvedCanonical = canonicalUrl || Astro.url.href;
const resolvedOgImage = new URL(ogImage, Astro.site).href;

// BreadcrumbList JSON-LD
const breadcrumbJsonLd =
  breadcrumbs && breadcrumbs.length > 0
    ? {
        '@context': 'https://schema.org',
        '@type': 'BreadcrumbList',
        itemListElement: breadcrumbs.map((crumb, index) => {
          const item: Record<string, string | number> = {
            '@type': 'ListItem',
            position: index + 1,
            name: crumb.name,
          };
          if (crumb.url) {
            item.item = new URL(crumb.url, Astro.site).href;
          }
          return item;
        }),
      }
    : null;

// JSON-LD structured data
const logoUrl = new URL(site.logoPath, Astro.site).href;

const jsonLd = isArticle
  ? {
      '@context': 'https://schema.org',
      '@type': 'Article',
      headline: title,
      description: description,
      image: resolvedOgImage,
      datePublished: pubDate?.toISOString(),
      dateModified: updatedDate?.toISOString() || pubDate?.toISOString(),
      author: {
        '@type': 'Organization',
        name: site.author.name,
        url: new URL(site.author.aboutPagePath, Astro.site).href,
      },
      publisher: {
        '@type': 'Organization',
        name: siteName,
        logo: {
          '@type': 'ImageObject',
          url: logoUrl,
        },
      },
      mainEntityOfPage: {
        '@type': 'WebPage',
        '@id': resolvedCanonical,
      },
    }
  : {
      '@context': 'https://schema.org',
      '@type': 'WebSite',
      name: siteName,
      description: description,
      url: Astro.site?.href,
      publisher: {
        '@type': 'Organization',
        name: siteName,
        logo: {
          '@type': 'ImageObject',
          url: logoUrl,
        },
      },
    };
---

<!-- Primary Meta Tags -->
<title>{fullTitle}</title>
<meta name="title" content={fullTitle} />
<meta name="description" content={description} />
{noindex && <meta name="robots" content="noindex, nofollow" />}
<meta name="format-detection" content="telephone=no" />
<link rel="canonical" href={resolvedCanonical} />
<link rel="alternate" type="application/rss+xml" title={`${siteName} RSS`} href="/rss.xml" />

<!-- Open Graph / Facebook -->
<meta property="og:type" content={isArticle ? 'article' : 'website'} />
<meta property="og:url" content={resolvedCanonical} />
<meta property="og:title" content={fullTitle} />
<meta property="og:description" content={description} />
<meta property="og:image" content={resolvedOgImage} />
<meta property="og:site_name" content={siteName} />
<meta property="og:locale" content={site.locale} />

<!-- Twitter -->
<meta property="twitter:card" content="summary_large_image" />
<meta property="twitter:url" content={resolvedCanonical} />
<meta property="twitter:title" content={fullTitle} />
<meta property="twitter:description" content={description} />
<meta property="twitter:image" content={resolvedOgImage} />

{isArticle && pubDate && <meta property="article:published_time" content={pubDate.toISOString()} />}
{
  isArticle && updatedDate && (
    <meta property="article:modified_time" content={updatedDate.toISOString()} />
  )
}

<!-- JSON-LD Structured Data -->
<script type="application/ld+json" set:html={JSON.stringify(jsonLd)} />

{
  breadcrumbJsonLd && (
    <script type="application/ld+json" set:html={JSON.stringify(breadcrumbJsonLd)} />
  )
}

{additionalJsonLd.map((ld) => (
  <script type="application/ld+json" set:html={JSON.stringify(ld)} />
))}
