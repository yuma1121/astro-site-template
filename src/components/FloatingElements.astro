---
import { site } from '../config/site';

const { button, banner } = site.floating;

interface Props {
  isArticle?: boolean;
}

const { isArticle = false } = Astro.props;
---

<!-- スマホ目次フローティング（記事ページのみ・lg未満で表示） -->
{isArticle && (
  <div class="floating-toc-wrapper" id="floating-toc-wrapper">
    <div class="floating-toc-panel is-hidden" id="floating-toc-panel">
      <div class="floating-toc-panel-header">
        <span class="floating-toc-panel-title">目次</span>
      </div>
      <nav class="floating-toc-nav" id="floating-toc-nav"></nav>
    </div>
    <div class="floating-btn-row">
      <button
        id="floating-top-btn"
        class="floating-circle-btn is-hidden"
        type="button"
        aria-label="ページトップへ戻る"
      >
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
          <path d="M5 15l7-7 7 7" />
        </svg>
      </button>
      <button
        id="floating-toc-btn"
        class="floating-toc-btn"
        type="button"
        aria-label="目次を開閉"
      >
        <svg id="floating-toc-icon-open" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <line x1="8" y1="6" x2="21" y2="6" /><line x1="8" y1="12" x2="21" y2="12" /><line x1="8" y1="18" x2="21" y2="18" />
          <line x1="3" y1="6" x2="3.01" y2="6" /><line x1="3" y1="12" x2="3.01" y2="12" /><line x1="3" y1="18" x2="3.01" y2="18" />
        </svg>
        <svg id="floating-toc-icon-close" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display:none;">
          <line x1="18" y1="6" x2="6" y2="18" /><line x1="6" y1="6" x2="18" y2="18" />
        </svg>
        <span>目次</span>
      </button>
    </div>
  </div>
)}

<!-- フローティングCTAボタン -->
{button.enabled && (
  <a
    href={button.url}
    class="floating-cta-btn"
    style={`background:${button.bgColor};color:${button.textColor};`}
    {...(button.external ? { target: '_blank', rel: 'noopener noreferrer' } : {})}
  >
    {button.label}
  </a>
)}

<!-- フローティングバナー -->
{banner.enabled && (
  <div
    id="floating-banner"
    class="floating-banner"
    style={`background:${banner.bgColor};color:${banner.textColor};`}
  >
    <a
      href={banner.url}
      class="floating-banner-inner"
      style={`color:${banner.textColor};`}
      {...(banner.external ? { target: '_blank', rel: 'noopener noreferrer' } : {})}
    >
      <span class="floating-banner-text">{banner.text}</span>
      <span
        class="floating-banner-cta"
        style={`background:${banner.ctaBgColor};color:${banner.ctaTextColor};`}
      >
        {banner.cta}
      </span>
    </a>
    {banner.dismissible && (
      <button id="floating-banner-close" class="floating-banner-close" type="button" aria-label="閉じる">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
          <line x1="18" y1="6" x2="6" y2="18" /><line x1="6" y1="6" x2="18" y2="18" />
        </svg>
      </button>
    )}
  </div>
)}

<style>
  .floating-toc-wrapper {
    position: fixed;
    bottom: 1.25rem;
    right: 1.25rem;
    z-index: 40;
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    gap: 0.5rem;
  }

  .floating-btn-row {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .floating-circle-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 2.5rem;
    height: 2.5rem;
    background: #fff;
    color: #6b7280;
    border: 1px solid #e5e7eb;
    border-radius: 50%;
    box-shadow: 0 2px 12px rgba(0, 0, 0, 0.1);
    cursor: pointer;
    -webkit-tap-highlight-color: transparent;
    transition: transform 0.15s, opacity 0.2s;
  }

  .floating-circle-btn:active {
    transform: scale(0.9);
  }

  .floating-circle-btn.is-hidden {
    display: none;
  }

  .floating-toc-btn {
    display: flex;
    align-items: center;
    gap: 0.375rem;
    padding: 0.625rem 0.875rem;
    background: #fff;
    color: #374151;
    border: 1px solid #e5e7eb;
    border-radius: 2rem;
    box-shadow: 0 2px 12px rgba(0, 0, 0, 0.1);
    font-size: 0.75rem;
    font-weight: 600;
    cursor: pointer;
    -webkit-tap-highlight-color: transparent;
    transition: box-shadow 0.15s, transform 0.15s, background 0.15s, color 0.15s;
  }

  .floating-toc-btn:active {
    transform: scale(0.95);
  }

  .floating-toc-btn.is-open {
    background: #374151;
    color: #fff;
    border-color: #374151;
  }

  .floating-toc-panel {
    width: 16rem;
    max-height: 60vh;
    background: #fff;
    border: 1px solid #e5e7eb;
    border-radius: 0.75rem;
    box-shadow: 0 4px 24px rgba(0, 0, 0, 0.12);
    overflow: hidden;
    display: flex;
    flex-direction: column;
    animation: tocPanelIn 0.2s ease;
  }

  .floating-toc-panel.is-hidden {
    display: none;
  }

  .floating-toc-panel-header {
    padding: 0.75rem 1rem 0.5rem;
    border-bottom: 1px solid #f3f4f6;
    flex-shrink: 0;
  }

  .floating-toc-panel-title {
    font-size: 0.75rem;
    font-weight: 700;
    color: #6b7280;
    letter-spacing: 0.05em;
  }

  .floating-toc-nav {
    overflow-y: auto;
    padding: 0.375rem 0;
    -webkit-overflow-scrolling: touch;
  }

  .floating-toc-nav :global(a) {
    display: block;
    padding: 0.4375rem 0.875rem;
    font-size: 0.8125rem;
    color: #374151;
    text-decoration: none;
    transition: background 0.15s;
    line-height: 1.4;
  }

  .floating-toc-nav :global(a:active) {
    background: #f3f4f6;
  }

  .floating-toc-nav :global(a.toc-h3) {
    padding-left: 1.75rem;
    font-size: 0.75rem;
    color: #9ca3af;
  }

  @keyframes tocPanelIn {
    from { opacity: 0; transform: translateY(0.5rem) scale(0.95); }
    to { opacity: 1; transform: translateY(0) scale(1); }
  }

  @media (min-width: 1024px) {
    .floating-toc-wrapper { display: none; }
  }

  /* CTA */
  .floating-cta-btn {
    position: fixed;
    bottom: 1.25rem;
    left: 1.25rem;
    z-index: 40;
    display: inline-flex;
    align-items: center;
    padding: 0.625rem 1.25rem;
    border-radius: 2rem;
    font-size: 0.8125rem;
    font-weight: 700;
    text-decoration: none;
    box-shadow: 0 2px 12px rgba(0, 0, 0, 0.15);
    transition: transform 0.15s;
  }

  .floating-cta-btn:active { transform: scale(0.95); }

  @media (min-width: 1024px) {
    .floating-cta-btn { bottom: 1.5rem; left: 1.5rem; }
  }

  /* Banner */
  .floating-banner {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    z-index: 45;
    display: flex;
    align-items: center;
    box-shadow: 0 -2px 12px rgba(0, 0, 0, 0.1);
  }

  .floating-banner-inner {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.75rem;
    padding: 0.75rem 1rem;
    text-decoration: none;
  }

  .floating-banner-text { font-size: 0.8125rem; font-weight: 600; }

  .floating-banner-cta {
    flex-shrink: 0;
    padding: 0.375rem 0.875rem;
    border-radius: 0.25rem;
    font-size: 0.75rem;
    font-weight: 700;
  }

  .floating-banner-close {
    flex-shrink: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 2.5rem;
    color: inherit;
    opacity: 0.6;
    background: none;
    border: none;
    border-left: 1px solid rgba(255, 255, 255, 0.2);
    cursor: pointer;
  }

  .floating-banner-close:hover { opacity: 1; }
</style>

<script is:inline>
  (function() {
    var btn = document.getElementById('floating-toc-btn');
    var panel = document.getElementById('floating-toc-panel');
    var nav = document.getElementById('floating-toc-nav');
    var iconOpen = document.getElementById('floating-toc-icon-open');
    var iconClose = document.getElementById('floating-toc-icon-close');
    var wrapper = document.getElementById('floating-toc-wrapper');

    if (!btn || !panel || !nav) return;

    // 記事からh2/h3を取得して目次を構築
    var article = document.getElementById('article-body');
    if (!article) return;
    var headings = article.querySelectorAll('h2, h3');
    if (headings.length === 0) {
      if (wrapper) wrapper.style.display = 'none';
      return;
    }

    for (var i = 0; i < headings.length; i++) {
      var h = headings[i];
      if (!h.id) h.id = 'heading-' + i;
      var a = document.createElement('a');
      a.href = '#' + h.id;
      a.textContent = h.textContent;
      if (h.tagName === 'H3') a.className = 'toc-h3';
      a.addEventListener('click', function() { closeToc(); });
      nav.appendChild(a);
    }

    var isOpen = false;

    function openToc() {
      isOpen = true;
      panel.classList.remove('is-hidden');
      btn.classList.add('is-open');
      if (iconOpen) iconOpen.style.display = 'none';
      if (iconClose) iconClose.style.display = '';
    }

    function closeToc() {
      isOpen = false;
      panel.classList.add('is-hidden');
      btn.classList.remove('is-open');
      if (iconOpen) iconOpen.style.display = '';
      if (iconClose) iconClose.style.display = 'none';
    }

    btn.addEventListener('click', function(e) {
      e.stopPropagation();
      if (isOpen) {
        closeToc();
      } else {
        openToc();
      }
    });

    // パネル内クリックはバブリングを止める
    panel.addEventListener('click', function(e) {
      e.stopPropagation();
    });

    // パネル外クリックで閉じる
    document.addEventListener('click', function() {
      if (isOpen) closeToc();
    });

    // トップに戻るボタン
    var topBtn = document.getElementById('floating-top-btn');
    if (topBtn) {
      window.addEventListener('scroll', function() {
        if (window.scrollY > 300) {
          topBtn.classList.remove('is-hidden');
        } else {
          topBtn.classList.add('is-hidden');
        }
      });
      topBtn.addEventListener('click', function() {
        window.scrollTo({ top: 0, behavior: 'smooth' });
      });
    }

    // バナー閉じる
    var banner = document.getElementById('floating-banner');
    var bannerClose = document.getElementById('floating-banner-close');
    if (banner && bannerClose) {
      bannerClose.addEventListener('click', function() {
        banner.style.display = 'none';
      });
    }
  })();
</script>
