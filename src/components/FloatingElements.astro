---
import { site } from '../config/site';

const { button, banner } = site.floating;

interface Props {
  /** 記事ページかどうか（目次ボタンは記事ページのみ） */
  isArticle?: boolean;
}

const { isArticle = false } = Astro.props;
---

<!-- スマホ目次フローティング（記事ページのみ・lg未満で表示） -->
{isArticle && (
  <div class="floating-toc-wrapper" id="floating-toc-wrapper">
    <!-- 目次パネル（ボタンの上に展開） -->
    <div class="floating-toc-panel" id="floating-toc-panel" hidden>
      <div class="floating-toc-panel-header">
        <span class="floating-toc-panel-title">目次</span>
      </div>
      <nav class="floating-toc-nav" id="floating-toc-nav"></nav>
    </div>
    <!-- トグルボタン -->
    <button
      id="floating-toc-btn"
      class="floating-toc-btn"
      aria-label="目次を開閉"
      aria-expanded="false"
    >
      <svg class="floating-toc-icon" id="floating-toc-icon-list" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <line x1="8" y1="6" x2="21" y2="6" /><line x1="8" y1="12" x2="21" y2="12" /><line x1="8" y1="18" x2="21" y2="18" />
        <line x1="3" y1="6" x2="3.01" y2="6" /><line x1="3" y1="12" x2="3.01" y2="12" /><line x1="3" y1="18" x2="3.01" y2="18" />
      </svg>
      <svg class="floating-toc-icon" id="floating-toc-icon-close" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display:none">
        <line x1="18" y1="6" x2="6" y2="18" /><line x1="6" y1="6" x2="18" y2="18" />
      </svg>
      <span class="floating-toc-label">目次</span>
    </button>
  </div>
)}

<!-- フローティングCTAボタン -->
{button.enabled && (
  <a
    href={button.url}
    class="floating-cta-btn"
    style={`background:${button.bgColor};color:${button.textColor};`}
    {...(button.external ? { target: '_blank', rel: 'noopener noreferrer' } : {})}
  >
    {button.label}
  </a>
)}

<!-- フローティングバナー -->
{banner.enabled && (
  <div
    id="floating-banner"
    class="floating-banner"
    style={`background:${banner.bgColor};color:${banner.textColor};`}
  >
    <a
      href={banner.url}
      class="floating-banner-inner"
      style={`color:${banner.textColor};`}
      {...(banner.external ? { target: '_blank', rel: 'noopener noreferrer' } : {})}
    >
      <span class="floating-banner-text">{banner.text}</span>
      <span
        class="floating-banner-cta"
        style={`background:${banner.ctaBgColor};color:${banner.ctaTextColor};`}
      >
        {banner.cta}
      </span>
    </a>
    {banner.dismissible && (
      <button id="floating-banner-close" class="floating-banner-close" aria-label="閉じる">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
          <line x1="18" y1="6" x2="6" y2="18" /><line x1="6" y1="6" x2="18" y2="18" />
        </svg>
      </button>
    )}
  </div>
)}

<style>
  /* ========================
     目次フローティング
     ======================== */
  .floating-toc-wrapper {
    position: fixed;
    bottom: 1.25rem;
    right: 1.25rem;
    z-index: 40;
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    gap: 0.5rem;
  }

  .floating-toc-btn {
    display: flex;
    align-items: center;
    gap: 0.375rem;
    padding: 0.625rem 0.875rem;
    background: #fff;
    color: #374151;
    border: 1px solid #e5e7eb;
    border-radius: 2rem;
    box-shadow: 0 2px 12px rgba(0, 0, 0, 0.1);
    font-size: 0.75rem;
    font-weight: 600;
    cursor: pointer;
    -webkit-tap-highlight-color: transparent;
    transition: box-shadow 0.15s, transform 0.15s;
  }

  .floating-toc-btn:active {
    transform: scale(0.95);
  }

  .floating-toc-btn[aria-expanded="true"] {
    background: #374151;
    color: #fff;
    border-color: #374151;
  }

  .floating-toc-label {
    letter-spacing: 0.025em;
  }

  .floating-toc-icon {
    flex-shrink: 0;
  }

  /* 目次パネル */
  .floating-toc-panel {
    width: 16rem;
    max-height: 60vh;
    background: #fff;
    border: 1px solid #e5e7eb;
    border-radius: 0.75rem;
    box-shadow: 0 4px 24px rgba(0, 0, 0, 0.12);
    overflow: hidden;
    display: flex;
    flex-direction: column;
    animation: tocPanelIn 0.2s ease;
  }

  .floating-toc-panel-header {
    padding: 0.75rem 1rem 0.5rem;
    border-bottom: 1px solid #f3f4f6;
    flex-shrink: 0;
  }

  .floating-toc-panel-title {
    font-size: 0.75rem;
    font-weight: 700;
    color: #6b7280;
    letter-spacing: 0.05em;
    text-transform: uppercase;
  }

  .floating-toc-nav {
    overflow-y: auto;
    padding: 0.375rem 0;
    -webkit-overflow-scrolling: touch;
  }

  .floating-toc-nav :global(a) {
    display: block;
    padding: 0.4375rem 0.875rem;
    font-size: 0.8125rem;
    color: #374151;
    text-decoration: none;
    transition: background 0.15s;
    line-height: 1.4;
  }

  .floating-toc-nav :global(a:active) {
    background: #f3f4f6;
  }

  .floating-toc-nav :global(a.toc-h3) {
    padding-left: 1.75rem;
    font-size: 0.75rem;
    color: #9ca3af;
  }

  @keyframes tocPanelIn {
    from {
      opacity: 0;
      transform: translateY(0.5rem) scale(0.95);
    }
    to {
      opacity: 1;
      transform: translateY(0) scale(1);
    }
  }

  /* デスクトップ（サイドバーTOCあり）では非表示 */
  @media (min-width: 1024px) {
    .floating-toc-wrapper { display: none; }
  }

  /* ========================
     フローティングCTAボタン
     ======================== */
  .floating-cta-btn {
    position: fixed;
    bottom: 1.25rem;
    left: 1.25rem;
    z-index: 40;
    display: inline-flex;
    align-items: center;
    padding: 0.625rem 1.25rem;
    border-radius: 2rem;
    font-size: 0.8125rem;
    font-weight: 700;
    text-decoration: none;
    box-shadow: 0 2px 12px rgba(0, 0, 0, 0.15);
    transition: transform 0.15s, box-shadow 0.15s;
  }

  .floating-cta-btn:active {
    transform: scale(0.95);
  }

  @media (min-width: 1024px) {
    .floating-cta-btn {
      bottom: 1.5rem;
      left: 1.5rem;
    }
  }

  /* ========================
     フローティングバナー
     ======================== */
  .floating-banner {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    z-index: 45;
    display: flex;
    align-items: center;
    padding: 0;
    box-shadow: 0 -2px 12px rgba(0, 0, 0, 0.1);
  }

  .floating-banner-inner {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.75rem;
    padding: 0.75rem 1rem;
    text-decoration: none;
  }

  .floating-banner-text {
    font-size: 0.8125rem;
    font-weight: 600;
  }

  .floating-banner-cta {
    flex-shrink: 0;
    padding: 0.375rem 0.875rem;
    border-radius: 0.25rem;
    font-size: 0.75rem;
    font-weight: 700;
  }

  .floating-banner-close {
    flex-shrink: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 2.5rem;
    height: 100%;
    color: inherit;
    opacity: 0.6;
    background: none;
    border: none;
    border-left: 1px solid rgba(255, 255, 255, 0.2);
    cursor: pointer;
    transition: opacity 0.15s;
  }

  .floating-banner-close:hover {
    opacity: 1;
  }
</style>

<script>
  function initFloatingTOC() {
    const btn = document.getElementById('floating-toc-btn');
    const panel = document.getElementById('floating-toc-panel');
    const nav = document.getElementById('floating-toc-nav');
    const iconList = document.getElementById('floating-toc-icon-list');
    const iconClose = document.getElementById('floating-toc-icon-close');

    if (!btn || !panel || !nav) return;

    const panelEl = panel as HTMLElement;
    const btnEl = btn as HTMLButtonElement;

    // 記事のh2/h3から目次を構築
    const article = document.getElementById('article-body');
    if (!article) return;
    const headings = article.querySelectorAll('h2, h3');
    if (headings.length === 0) {
      const wrapper = document.getElementById('floating-toc-wrapper');
      if (wrapper) wrapper.style.display = 'none';
      return;
    }

    headings.forEach((heading, index) => {
      if (!heading.id) heading.id = 'heading-' + index;
      const a = document.createElement('a');
      a.href = '#' + heading.id;
      a.textContent = heading.textContent;
      if (heading.tagName === 'H3') a.className = 'toc-h3';
      a.addEventListener('click', () => toggle(false));
      nav.appendChild(a);
    });

    function toggle(open?: boolean) {
      const isOpen = open ?? panelEl.hidden;
      panelEl.hidden = !isOpen;
      btnEl.setAttribute('aria-expanded', String(isOpen));
      if (iconList) iconList.style.display = isOpen ? 'none' : '';
      if (iconClose) iconClose.style.display = isOpen ? '' : 'none';
    }

    btnEl.addEventListener('click', () => toggle());

    // パネル外クリックで閉じる
    document.addEventListener('click', (e) => {
      const wrapper = document.getElementById('floating-toc-wrapper');
      if (wrapper && !wrapper.contains(e.target as Node) && !panelEl.hidden) {
        toggle(false);
      }
    });
  }

  function initFloatingBanner() {
    const banner = document.getElementById('floating-banner');
    const closeBtn = document.getElementById('floating-banner-close');
    if (!banner || !closeBtn) return;

    closeBtn.addEventListener('click', () => {
      banner.style.display = 'none';
    });
  }

  initFloatingTOC();
  initFloatingBanner();
</script>
